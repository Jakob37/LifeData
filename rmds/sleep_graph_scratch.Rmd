---
title: "R Notebook"
output: html_notebook
---

# Setup libraries

```{r}
quiet <- suppressPackageStartupMessages

quiet(library(tidyverse))
#library(hms)
quiet(library(lubridate))
quiet(library(scales))
quiet(library(ggpubr))
theme_set(theme_classic())
quiet(library(janitor))
```

# Load and parse data

## Parse functions

```{r}
get_hour <- function(posix_col, div_hour=TRUE) {
    base <- as.numeric(posix_col - trunc(posix_col, "days"))
    if (div_hour) {
        base / 60 / 60
    }
    else {
        base
    }
}

setup_time_diff_cols <- function(time_df, start_date_col, end_date_col) {
    
    time_df$start_date <- time_df[[start_date_col]]
    time_df$end_date <- time_df[[end_date_col]]
    
    time_df$start_time <- get_hour(time_df$start_date)
    time_df$end_time <- get_hour(time_df$end_date)
    time_df$hours <- (time_df$end_date - time_df$start_date)
    time_df
}
```


## Load time datasets

```{r}
sleep_df <- read_csv("sleep.csv") %>% 
    janitor::clean_names() %>% 
    setup_time_diff_cols("fell_asleep", "woke_up")
head(sleep_df)

computer_df <- read_csv("turn-off.csv", na="-") %>% 
    janitor::clean_names() %>% 
    filter(!is.na(turned_on)) %>%
    setup_time_diff_cols("turned_off_computers_at", "turned_on")
computer_df

study_df <- read_csv("study-sessions.csv") %>%
    janitor::clean_names() %>%
    setup_time_diff_cols("start", "end")
```

# Setup strip plot

## Functions

```{r}
extract_sleep_times <- function(start, finish) {
    hour_sec <- 3600 / 4
    sleep_times_raw <- seq(
        as.POSIXct(start), 
        as.POSIXct(finish), 
        by = hour_sec
    )
    as.POSIXct(sleep_times_raw + 3600, origin='1970-01-01 00:00:00', tz="UTC")
}


```


```{r fig.height=5}
sleep_times_list <- apply(sleep_df, 1, function(row) { 
    # row[[2]]
    message(row[[2]])
    message(row[[3]])
    extract_sleep_times(row[[2]], row[[3]])
})

all_sleep_times <- unlist(sleep_times_list)

all_times <- seq(min(sleep_df$start_date), max(sleep_df$end_date), by = 3600 / 4)
all_times_df <- data.frame(all_times)
all_times_df$time <- as.numeric(all_times - trunc(all_times, "days")) / 3600
all_times_df$date <- as.Date(ymd_hms(all_times_df$all_times))
all_times_df$is_sleeping <- all_times_df$all_times %in% all_sleep_times

tail(all_times_df, 100)

all_times_df %>% head() %>% filter(date >= as.Date("2019-10-28", origin='1970-01-01 00:00:00', tz="UTC"))

get_range <- function(raw_df, start="2019-12-01", end="2019-12-31") {
    raw_df %>%
        filter(date >= as.Date(start, origin='1970-01-01 00:00:00', tz="UTC")) %>% 
        filter(date <= as.Date(end, origin='1970-01-01 00:00:00', tz="UTC"))
}

```

## Plotting



```{r}
plt <- ggplot(all_times_df %>% get_range("2019-12-01", "2019-12-31"), aes(x=date, y=time, fill=is_sleeping)) +
    geom_tile(width=0.5) +
    scale_fill_manual(values=c("#cccccc", "#007700")) +
    ggtitle("Sleeping pattern December") +
    scale_x_date(date_breaks = "1 day") +
    theme(axis.text.x = element_text(angle=90, vjust=0.5))

plt
ggsave(plt, filename = "~/Desktop/sleep_pattern.png", width=10, height=5)

```










